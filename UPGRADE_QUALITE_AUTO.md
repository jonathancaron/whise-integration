# üîÑ Mise √† niveau automatique de la qualit√© des images

## üìã Probl√®me r√©solu

### Situation
Des images existantes en **basse qualit√©** (640x480 ou 200px) ne sont pas mises √† jour lors des synchronisations, m√™me si la configuration demande une **haute qualit√©** (1600px).

**Exemple concret :**
```
Image actuelle : whise-7136172-9-72068404.jpg (640x480 - urlLarge)
Configuration : urlXXL (1600px)
Probl√®me : L'image n'est pas mise √† jour car le syst√®me pense qu'elle existe d√©j√†
```

### Cause
Le syst√®me de v√©rification d'existence emp√™chait le re-t√©l√©chargement :
```php
// Ancien code
if (image_exists_in_db) {
    skip_download(); // ‚ùå M√™me si c'est la mauvaise qualit√© !
}
```

---

## ‚úÖ Solution impl√©ment√©e

### D√©tection et suppression automatique (V2 - Am√©lior√©e)

Le syst√®me d√©tecte maintenant **automatiquement** les images de qualit√© inf√©rieure et les supprime pour forcer le re-t√©l√©chargement en haute qualit√©.

**Am√©lioration V2 :** Recherche par nom de fichier si `_whise_image_id` est absent (anciennes images).

#### Hi√©rarchie de qualit√©
```php
$quality_hierarchy = [
    'urlXXL'   => 0,  // 1600px+ (Haute qualit√©)
    'urlLarge' => 1,  // 640px (Qualit√© moyenne)
    'urlSmall' => 2   // 200px (Qualit√© r√©duite)
];
```

#### Logique de mise √† niveau
```
1. Configuration actuelle : urlXXL (niveau 0)
2. Image existante : urlLarge (niveau 1)
3. Comparaison : 1 > 0 ‚Üí Image de qualit√© inf√©rieure
4. Action : Supprimer l'image existante
5. R√©sultat : Re-t√©l√©chargement en urlXXL
```

---

## üîß Impl√©mentation technique

### Ligne ~1004-1071 dans `class-sync-manager.php`

```php
// V√©rifier aussi si des images de mauvaise qualit√© existent pour cette image Whise
$whise_image_id = $picture['id'];
$all_quality_attachments = get_posts([
    'post_type' => 'attachment',
    'meta_query' => [
        [
            'key' => '_whise_image_id',
            'value' => $whise_image_id,
            'compare' => '='
        ]
    ],
    'numberposts' => -1
]);

// Supprimer les attachments de mauvaise qualit√© si on a configur√© une meilleure qualit√©
$quality_hierarchy = ['urlXXL', 'urlLarge', 'urlSmall'];
$preferred_quality_level = array_search($preferred_quality, $quality_hierarchy);

foreach ($all_quality_attachments as $old_attachment) {
    $old_url = get_post_meta($old_attachment->ID, '_whise_original_url', true);
    
    // D√©tecter la qualit√© de l'ancienne image
    $old_quality_level = -1;
    if (strpos($old_url, '/1600/') !== false || strpos($old_url, 'urlXXL') !== false) {
        $old_quality_level = 0; // urlXXL
    } elseif (strpos($old_url, '/640/') !== false || strpos($old_url, 'urlLarge') !== false) {
        $old_quality_level = 1; // urlLarge
    } elseif (strpos($old_url, '/200/') !== false || strpos($old_url, 'urlSmall') !== false) {
        $old_quality_level = 2; // urlSmall
    }
    
    // Si l'ancienne image est de qualit√© inf√©rieure, la supprimer
    if ($old_quality_level > $preferred_quality_level && $old_quality_level !== -1) {
        $this->log('DEBUG - Property ' . $whise_id . ' - Deleting lower quality image (level ' . $old_quality_level . ' vs ' . $preferred_quality_level . '): attachment ID ' . $old_attachment->ID);
        wp_delete_attachment($old_attachment->ID, true);
        
        // Supprimer aussi le fichier physique et ses variantes
        $file_path = get_attached_file($old_attachment->ID);
        if ($file_path && file_exists($file_path)) {
            @unlink($file_path);
            
            // Supprimer les variantes (-1, -2, etc.)
            $path_info = pathinfo($file_path);
            $filename_without_ext = $path_info['filename'];
            for ($i = 1; $i <= 10; $i++) {
                $variant_path = $path_info['dirname'] . '/' . $filename_without_ext . '-' . $i . '.' . $path_info['extension'];
                if (file_exists($variant_path)) {
                    @unlink($variant_path);
                    $this->log('DEBUG - Property ' . $whise_id . ' - Deleted variant file: ' . basename($variant_path));
                }
            }
        }
        
        // Marquer qu'il faut re-t√©l√©charger
        $existing_attachment = [];
    }
}
```

### Ce que fait cette correction

1. ‚úÖ **D√©tecte** toutes les images existantes pour le m√™me `whise_image_id`
2. ‚úÖ **Analyse** la qualit√© de chaque image via l'URL (d√©tection de `/1600/`, `/640/`, `/200/`)
3. ‚úÖ **Compare** avec la qualit√© configur√©e
4. ‚úÖ **Supprime** les images de qualit√© inf√©rieure (DB + fichier physique + variantes)
5. ‚úÖ **Force** le re-t√©l√©chargement en haute qualit√©

---

## üöÄ Cas d'usage

### Sc√©nario 1 : Upgrade de qualit√©

**Avant :**
```
Configuration : urlLarge (640px)
Images existantes : 2011 images en 640px
```

**Action :**
```
1. Changer la configuration : urlXXL (1600px)
2. Lancer une synchronisation
```

**R√©sultat :**
```
‚úÖ Toutes les images 640px supprim√©es automatiquement
‚úÖ Re-t√©l√©chargement en 1600px
‚úÖ Mise √† niveau automatique sans intervention manuelle
```

---

### Sc√©nario 2 : Images h√©rit√©es

**Avant :**
```
Configuration actuelle : urlXXL (1600px)
Images existantes : M√©lange de 640px et 1600px (r√©sidus d'anciens imports)
```

**Action :**
```
1. Lancer une synchronisation
```

**R√©sultat :**
```
‚úÖ Images 640px d√©tect√©es et supprim√©es
‚úÖ Re-t√©l√©chargement en 1600px
‚úÖ Uniformisation de la qualit√©
```

---

### Sc√©nario 3 : Votre cas sp√©cifique

**Probl√®me initial :**
```
Image : whise-7136172-9-72068404.jpg
Qualit√© actuelle : 640x480 (urlLarge)
Configuration : urlXXL (1600px)
Probl√®me : Image non mise √† jour
```

**Solution automatique :**
```
1. Synchronisation d√©tecte whise_image_id: 72068404
2. Trouve l'attachment existant en 640px
3. D√©tecte "/640/" dans l'URL ‚Üí niveau 1
4. Compare avec urlXXL (niveau 0)
5. 1 > 0 ‚Üí Qualit√© inf√©rieure
6. Supprime l'attachment DB
7. Supprime le fichier physique et variantes
8. Re-t√©l√©charge en 1600px (urlXXL)
```

---

## üìä Logs attendus

### Lors de la synchronisation

```log
DEBUG - Property 7136172 - Processing 10 images
DEBUG - Property 7136172 - Using urlXXL (preferred quality) for image 72068404
DEBUG - Property 7136172 - Deleting lower quality image (level 1 vs 0): attachment ID 12345
DEBUG - Property 7136172 - Deleted variant file: whise-7136172-9-72068404-1.jpg
DEBUG - Property 7136172 - Deleted variant file: whise-7136172-9-72068404-2.jpg
DEBUG - Property 7136172 - Downloading image: https://...image.whise.eu/offices/xxx/estates/1600/xxx.jpg
DEBUG - Property 7136172 - Image uploaded successfully: whise-7136172-9-72068404.jpg
DEBUG - Property 7136172 - Gallery updated with 10 image attachments
```

### V√©rification post-synchronisation

```bash
# Consulter le log
tail -f wp-content/whise-integration-logs/sync-{date}.log | grep "Deleting lower quality"

# V√©rifier les fichiers
ls -la wp-content/uploads/2025/10/ | grep "whise-7136172-9-72068404"
# R√©sultat attendu : un seul fichier, en haute qualit√©
```

---

## üéØ Avantages

### ‚úÖ Automatique
- Aucune intervention manuelle requise
- D√©tection et mise √† niveau transparentes
- Applicable √† toutes les images

### ‚úÖ Intelligent
- D√©tecte la qualit√© via l'URL
- Compare avec la configuration actuelle
- Ne supprime que les images de qualit√© inf√©rieure

### ‚úÖ Complet
- Supprime l'attachment DB
- Supprime le fichier physique
- Supprime les variantes avec suffixes
- Force le re-t√©l√©chargement

### ‚úÖ S√ªr
- Ne touche que les images de qualit√© inf√©rieure
- Conserve les images de m√™me qualit√© ou sup√©rieure
- Logs d√©taill√©s pour tra√ßabilit√©

---

## ‚öôÔ∏è Configuration

### Param√®tre de qualit√©

```
Tableau de bord > Whise > R√©glages > Qualit√© des images
```

**Options :**
- **urlXXL** (1600px+) - Haute qualit√© ‚≠ê **Recommand√©**
- **urlLarge** (640px) - Qualit√© moyenne
- **urlSmall** (200px) - Qualit√© r√©duite

### Comportement

| Configuration | Images existantes | Action |
|---------------|-------------------|--------|
| urlXXL | urlLarge, urlSmall | ‚úÖ Suppression + Re-t√©l√©chargement |
| urlXXL | urlXXL | ‚è≠Ô∏è Conserv√©es (m√™me qualit√©) |
| urlLarge | urlSmall | ‚úÖ Suppression + Re-t√©l√©chargement |
| urlLarge | urlXXL | ‚è≠Ô∏è Conserv√©es (qualit√© sup√©rieure) |
| urlSmall | urlLarge, urlXXL | ‚è≠Ô∏è Conserv√©es (qualit√© sup√©rieure) |

---

## üß™ Tests de validation

### Test 1 : Upgrade simple

```bash
# 1. V√©rifier l'image actuelle
curl -I https://ahre.test.spleen-creation.be/wp-content/uploads/2025/10/whise-7136172-9-72068404.jpg
# V√©rifier Content-Length (si petit = 640px)

# 2. Lancer la synchronisation
wp cron event run whise_sync_properties_event

# 3. V√©rifier l'image apr√®s
curl -I https://ahre.test.spleen-creation.be/wp-content/uploads/2025/10/whise-7136172-9-72068404.jpg
# Content-Length devrait √™tre plus grand (1600px)

# 4. Consulter les logs
grep "Deleting lower quality" wp-content/whise-integration-logs/sync-*.log
```

### Test 2 : V√©rification en masse

```sql
-- Compter les images par qualit√© (avant)
SELECT 
    CASE 
        WHEN meta_value LIKE '%/1600/%' OR meta_value LIKE '%urlXXL%' THEN 'High (1600px)'
        WHEN meta_value LIKE '%/640/%' OR meta_value LIKE '%urlLarge%' THEN 'Medium (640px)'
        WHEN meta_value LIKE '%/200/%' OR meta_value LIKE '%urlSmall%' THEN 'Low (200px)'
        ELSE 'Unknown'
    END AS quality,
    COUNT(*) as count
FROM wp_postmeta
WHERE meta_key = '_whise_original_url'
GROUP BY quality;

-- Apr√®s synchronisation, v√©rifier que toutes sont en "High (1600px)"
```

---

## üìà Statistiques attendues

### Avant upgrade automatique
```
Haute qualit√© (urlXXL) : 0 (0%)
Qualit√© moyenne (urlLarge) : 2011 (100%)
Qualit√© r√©duite (urlSmall) : 0 (0%)
```

### Apr√®s synchronisation avec upgrade automatique
```
Haute qualit√© (urlXXL) : 2011 (100%) ‚úÖ
Qualit√© moyenne (urlLarge) : 0 (0%)
Qualit√© r√©duite (urlSmall) : 0 (0%)
```

---

## ‚ùì FAQ

**Q : Mes images de haute qualit√© seront-elles re-t√©l√©charg√©es inutilement ?**
> Non, seules les images de qualit√© **inf√©rieure** √† la configuration sont supprim√©es.

**Q : Combien de temps prend l'upgrade automatique ?**
> Identique √† une synchronisation normale. Chaque image de mauvaise qualit√© est supprim√©e et re-t√©l√©charg√©e.

**Q : Puis-je forcer un upgrade manuel pour une image sp√©cifique ?**
> Oui, supprimez l'attachment dans WordPress et lancez une synchronisation.

**Q : L'upgrade fonctionne-t-il pour les anciennes images sans re-synchronisation ?**
> Non, l'upgrade se fait **lors de la synchronisation**. Les images non synchronis√©es restent inchang√©es.

**Q : Que se passe-t-il si je baisse la qualit√© configur√©e ?**
> Les images de qualit√© sup√©rieure sont **conserv√©es**. Le syst√®me ne d√©grade jamais la qualit√©.

---

## üìù R√©sum√©

### Ce qui change

**Avant :**
```
‚ùå Images de mauvaise qualit√© bloqu√©es
‚ùå Upgrade manuel n√©cessaire
‚ùå Incoh√©rence de qualit√©
```

**Apr√®s :**
```
‚úÖ Upgrade automatique lors de la synchronisation
‚úÖ D√©tection intelligente de la qualit√©
‚úÖ Uniformisation garantie
‚úÖ Aucune intervention manuelle
```

---

**Date d'impl√©mentation :** Octobre 2025  
**Version du plugin :** 1.0.0  
**Status :** ‚úÖ Actif et fonctionnel
